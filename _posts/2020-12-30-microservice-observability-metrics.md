---
layout: post
title: "메트릭을 사용하여 마이크로 서비스를 모니터링하는 방법"
author: 'Code Tower'
thumbnail: https://www.freecodecamp.org/news/content/images/size/w600/2020/12/Microservice-Observability---Metrics.png
tags: undefined
---


이전 기사에서는 로그의 중요성과 정형화된 로깅과 비정형 로깅의 차이점에 대해 설명했습니다.

로그는 애플리케이션에 쉽게 통합되며 문자열 형태로 모든 유형의 데이터를 나타낼 수 있습니다.

반면에 메트릭은 데이터의 수치적 표현이다. 이러한 값은 종종 값을 계산하거나 측정하는 데 사용되며 일정 기간에 걸쳐 집계됩니다.

메트릭은 시스템의 과거 및 현재 상태에 대한 통찰력을 제공한다. 그것들은 숫자에 불과하기 때문에, 우리는 또한 그것들을 시스템의 미래 행동에 대한 통계 분석과 예측을 수행하는 데 사용할 수 있다.

또한 메트릭을 사용하여 경고를 트리거하고 시스템 동작의 문제에 대해 사용자에게 알릴 수 있습니다.

## 로그 및 메트릭의 형식 지정 방법

로그는 문자열로 표시됩니다. 간단한 텍스트, JSON 페이로드 또는 키-값 쌍(구조화된 로깅에 대해 논의한 것처럼)이 될 수 있다.

일반적인 로그 항목은 다음과 같습니다.

```undefined
[2020-09-27T18:54:41,500+0530]-[ERROR]-[InventoryValidator]-[13] Exception in fetching product information - Product Not Available
```

메트릭은 숫자로 표시됩니다. CPU 사용량, 오류 수 등과 같은 무언가를 측정하며 본질적으로 숫자입니다.

일반적인 메트릭은 다음과 같습니다.

```undefined
{class=InventoryValidator, exception=Product Not Available, timestamp=1609306200}
```

## 로그 및 메트릭의 해결 방법

로그에는 고해상도 데이터가 포함됩니다. 여기에는 이벤트에 대한 전체 정보가 포함되며 이벤트가 시스템을 통해 가져온 흐름(또는 경로)의 상관 관계를 나타내는 데 사용할 수 있습니다.

오류가 발생할 경우 로그는 예외의 전체 스택 추적을 포함하므로 다운스트림 시스템에서 발생한 문제를 보고 디버깅할 수도 있습니다.

![image](https://www.freecodecamp.org/news/content/images/2020/12/android-stack-trace-error-2.png)

간단히 말해, 로그는 특정 시간에 시스템에서 발생한 일을 알려줄 수 있습니다.

메트릭에는 저해상도 데이터가 포함됩니다. 여기에는 매개 변수 수(예: 요청, 오류 등)와 리소스 측정값(예: CPU 및 메모리 사용률)이 포함될 수 있습니다.

![image](https://www.freecodecamp.org/news/content/images/2020/12/tracing_aggregated_red_metrics.png)

간단히 말해, 메트릭은 특정 시간에 시스템에서 발생한 일의 개수를 제공할 수 있습니다.

## 로그 및 메트릭 비용

로그는 저장 비용이 많이 듭니다. 또한 로그의 스토리지 오버헤드는 시간이 지남에 따라 증가하며 트래픽 증가에 정비례합니다.

메트릭의 스토리지 오버헤드는 일정합니다. 메트릭의 저장 및 검색 비용은 트래픽 증가에 따라 크게 증가하지 않습니다. 그러나 각 메트릭으로 방출하는 변수의 수에 따라 달라집니다.

메트릭은 다음 두 가지 주요 정보로 식별됩니다.

- 메트릭 이름
- 태그 또는 레이블이라고 하는 키-값 쌍의 집합

이러한 값의 순열은 메트릭의 카디널리티를 제공합니다. 예를 들어, 호스트가 3개인 시스템의 CPU 활용도를 측정하는 경우 메트릭의 카디널리티 값은 3이며 다음과 같은 3개의 값을 가질 수 있습니다.

```undefined
(name=pod.cpu.utilization, host=A)
(name=pod.cpu.utilization, host=B)
(name=pod.cpu.utilization, host=C)
```

마찬가지로 호스트의 AWS 영역(us-west-1과 us-west-2)을 결정하는 메트릭에 다른 태그를 도입했다면 이제 카디널리티 값이 6인 메트릭이 있을 것이다.

## 황금 신호

황금색 신호는 시스템의 전반적인 상태를 모니터링하고 문제를 식별하는 효과적인 방법입니다.

- 가용성: 클라이언트의 관점에서 측정된 시스템의 상태(예: 총 요청의 오류 비율)입니다.
- 상태: 주기적인 ping을 사용하여 측정한 시스템의 상태입니다.
- 요청 속도: 시스템에 대한 수신 요청의 속도입니다.
- 포화도: 시스템의 사용 가능 또는 로드 상태(예: 대기열 크기 또는 사용 가능한 메모리)
- 사용률: 시스템 사용 기간(예: CPU 로드 또는 메모리 사용량) 이것은 백분율로 표시됩니다.
- 오류율: 시스템에서 생성되는 오류의 비율입니다.
- 지연 시간: 시스템의 응답 시간. 일반적으로 95번째 또는 99번째 백분위수로 측정됩니다.

## 리소스 메트릭

리소스 메트릭은 인프라 공급자(AWS CloudWatch 또는 Kubernetes 메트릭)에서 기본적으로 사용할 수 있으며 인프라 상태를 모니터링하는 데 사용됩니다.

- CPU/메모리 사용률: 시스템의 핵심 리소스 사용.
- 호스트 수: 시스템을 실행 중인 호스트/팟 수(팟 충돌로 인한 가용성 문제를 감지하는 데 사용됨).
- 라이브 스레드: 서비스에서 생성된 스레드(멀티 스레드에서의 문제를 감지하는 데 사용됨)입니다.
- 힙 사용량: 힙 메모리 사용량 통계(메모리 누수를 디버깅하는 데 도움이 될 수 있음)

## 비즈니스 메트릭

비즈니스 메트릭을 사용하여 서비스의 핵심 API 또는 기능과의 세부적인 상호 작용을 모니터링할 수 있습니다.

- 요청 속도: API에 대한 요청의 속도입니다.
- 오류율: API에서 발생 중인 오류의 비율입니다.
- 지연 시간: API의 요청을 처리하는 데 걸린 시간입니다.

메트릭은 시계열 데이터베이스에 저장되므로 시스템 상태를 측정하기 위해 메트릭에 대해 쿼리를 실행하는 것이 더 효율적이고 안정적입니다.

이러한 쿼리를 사용하여 시스템의 기록 상태를 나타내는 대시보드를 만들 수 있습니다.

![image](https://www.freecodecamp.org/news/content/images/2020/10/Screenshot-2020-10-03-at-3.20.16-PM.png)

또한 시스템에 문제가 있을 때 경고를 트리거하는 데에도 사용할 수 있습니다(예: 관찰된 오류의 수 증가 또는 CPU 사용률의 갑작스런 급증).

숫자 특성으로 인해 시스템 상태를 모니터링하기 위해 복잡한 수학 쿼리(예: 지난 Y분에서의 오류의 X%)를 생성할 수도 있다.

그러나 측정기준을 처리할 때 가장 큰 문제는 측정기준을 유용하게 만드는 적절한 양의 카디널리티를 결정하는 것과 동시에 비용을 억제하는 것이다.

너무 많은 메트릭 또는 너무 많은 차원을 가진 메트릭스를 방출하면 스토리지 및 처리 비용이 증가할 수 있습니다. 시스템에 대한 높은 수준의 그림을 제공하기에 충분한 최소 카디널리티를 선택해야 합니다.

로그와 메트릭 모두 고유한 장단점이 있습니다. 그러나 어떤 운영 체제에서도 시스템을 효과적으로 모니터링하고 모든 문제를 디버깅하기 위해 로그와 메트릭을 함께 사용해야 합니다.

메트릭은 종종 시스템 상태에 대한 첫 번째 가시선입니다. 아마존과 같은 전자상거래 애플리케이션의 예를 들어보자. 이러한 사용 사례에서 가장 중요한 지표는 성공 및 실패한 주문의 총 수입니다.

보통 날에 실패한 주문 수에 대한 메트릭은 0 또는 일부 매우 작은 수로 유지됩니다. 시스템에 주문이 갑자기 실패하기 시작하는 문제가 있는 경우 이 메트릭은 개수 증가를 표시합니다.

총 주문과 실패한 주문이라는 두 가지 메트릭의 조합에 대한 경고를 생성할 수 있습니다. 이렇게 하면 실패한 주문의 백분율이 특정 임계값(예: 5%)을 초과할 때 알림을 보낼 수 있습니다.

실패한 주문에 대해 알림을 받으면 로그를 참조하여 실패 원인을 찾을 수 있습니다. 로그에는 장애의 근본 원인을 식별할 수 있는 세부 스택 추적뿐만 아니라 장애로 이어지는 오류 메시지가 포함됩니다.

이 기사에서는 메트릭과 로그 간의 차이점과 메트릭이 시스템 상태를 보다 효율적으로 모니터링하는 데 어떻게 도움이 되는지 살펴봤습니다. 또한 메트릭스를 사용하여 Wavefront 및 Grafana와 같은 모니터링 소프트웨어를 사용하여 대시보드 및 경고를 생성할 수 있습니다.

또한 문제를 정확하게 감지하고 디버깅하기 위해 메트릭과 로그를 모두 함께 사용해야 합니다.

지금까지 나와 함께 있어줘서 고마워. 그 기사가 마음에 들었길 바라. 기술과 생활에 대해 정기적으로 논의하는 LinkedIn에서 저와 연결할 수 있습니다. 미디엄에 관한 다른 기사들도 보시죠. 🙂를 읽으며